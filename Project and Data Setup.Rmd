---
title: "Project and Data Setup"
output: html_notebook
---

# Overview

## Thanks


# Project Setup

## Lichess Database

## R

### Installing Tools

### Installing Packages


# Data Setup

## Code Overview

### Batch Process Files

### Structure Moves Into Data Frame

### Format and Order Columns




## Code

```{r, eval=FALSE, message=FALSE, warning=FALSE, results='hide'}

library(tidyverse)
library(stringr)


lines_to_read <- 100000


format_moves <- function(movetext)
{
  movetext_df <-
    str_match_all(
      movetext,
      "(\\d+)([.]+) ([a-h1-8KQRBNxO=#+-]+)([?!]*) \\{( \\[%eval ([0-9.#-]+)\\])? \\[%clk ([0-9:]+)\\] \\}"
    )
  
  movetext_df <- as.data.frame(movetext_df[[1]][, c(-1, -6)])
  
  colnames(movetext_df) <-
    c(
      "MoveNumber",
      "Indicator",
      "AlgebraicNotation",
      "Annotation",
      "Evaluation",
      "Clock"
    )
  
  movetext_df
}


lichess_db_standard_rated_filename <-
  "lichess_db_standard_rated_2017-04.pgn"
month <- "april"
month_piece <- 1

lines_to_skip <- 0

lines_read <- lines_to_read

# while (lines_read == lines_to_read)
for (i in 1:3)
{
  batch_read <-
    read_delim(
      paste0(
        lichess_db_standard_rated_filepath,
        lichess_db_standard_rated_filename
      ),
      delim = "\n",
      quote = "",
      escape_double = FALSE,
      col_names = FALSE,
      skip = lines_to_skip,
      n_max = lines_to_read
    ) %>%
    mutate(
      game_id = cumsum(str_detect(X1, "^\\[Event"))
    )
  
  lines_read <- nrow(batch_read)
  
  if (str_detect(batch_read[lines_to_read, 1], "^\\["))
  {
    batch_read <- batch_read %>%
      filter(game_id < max(game_id))
  }
  
  lines_to_skip <- lines_to_skip + nrow(batch_read)
  
  batch_read <- batch_read %>%
    mutate(
      key = if_else(
        str_detect(X1, "^\\["),
        str_replace(X1, "\\[(\\w+).+", "\\1"),
        "Moves"
      ),
      value = if_else(
        str_detect(X1, "^\\["),
        str_replace(X1, "\\[\\w+ \\\"(.+)\\\"\\]", "\\1"),
        X1
      )
    ) %>%
    select(-X1) %>%
    spread(key, value) %>%
    select(-game_id) %>%
    filter(str_detect(Moves, "eval")) %>%
    mutate(Moves = map(Moves, format_moves)) %>%
    select(
      Event,
      Site,
      White,
      Black,
      Result,
      UTCDate,
      UTCTime,
      WhiteElo,
      BlackElo,
      WhiteRatingDiff,
      BlackRatingDiff,
      WhiteTitle,
      BlackTitle,
      ECO,
      Opening,
      TimeControl,
      Termination,
      Moves
    )
  
  month_piece_filename <- paste0(month, "_", month_piece)
  assign(month_piece_filename, batch_read)
  # save(
  #   list = month_piece_filename,
  #   file = paste0(
  #     lichess_db_standard_rated_eval_stage_filepath,
  #     month_piece_filename,
  #     ".rda"
  #   )
  # )
  # rm(list = month_piece_filename)
  
  month_piece <- month_piece + 1
}

```








